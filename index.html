<html>
	<head>
		<script type="text/javascript" src="underscore.js"></script>
		<script type="text/javascript" src="jquery.js"></script>
		<script type="text/javascript" src="d3.v3.min.js"></script>
		<!--
		<script type="text/javascript" src="audio.js"></script>
		-->
		<script type="text/javascript" src="violent.js"></script>
		<script type="text/javascript" src="visualization.js"></script>
		<style>
			body {
				background-color: black;
				color: lightgray;
			}
			.visualization {
				width: 100%;
				height: 90%;
			}
			.d3-container, .d3-visualization {
				width: 100%;
				height: 100%;
			}
			.d3-history {
				position: absolute;
			}
			.video-item {
				width: 70%;
				margin-left: 15%;
				float: left;
			}
			video {
				width: 100%;
				height: 90%;
			}
			
			label {
				width: 60px;
				display: inline-block;
			}
			a {
				color: white;
			}
		</style>
	</head>
	<body>
		<h2>Beat detection via Web Audio API</h2>
		<video src="http://webmbassy.com/v/awesome-basketball-dance-changing-rooms-celebration-1358107409f.webm" type="video/webm" id="video" controls="" autoplay="" loop=""></video>

		<!--
		<h3 id="file_name">Select file, allow microphone or enter soundcloud url</h3>
		<p id="share_url"></p>
		<a href="/">Make new</a>
		<div class="hide-on-play">
			<input id="audio_file" type="file" accept="audio/*" />
			<br/>
			<label for="soundcloud_input">Music</label>
			<input id="soundcloud_input" name="searchterm" placeholder="search string or soundcloud url" size="70" value="http://soundcloud.com/knifepartyinc/knife-party-begin-again"></input>
			<input id="soundcloud_submit" type="button" value="PLAY"></input>
			<br/>
			<label for="webm_input">Webm</label>
			<input id="webm_input" name="webm" placeholder="webm url" size="70" value="http://webmbassy.com/v/awesome-basketball-dance-changing-rooms-celebration-1358107409f.webm"></input>
			<p>for example: http://webm.land/media/A0qi.webm</p>
		</div>
	-->
<!--
AUDIO:
		<audio controls>
			
	
				<source src="http://stream.futurice.com:8000/stream" type="audio/mpeg">
		</audio>
-->
		<div class="visualization">
			<div class="d3-container">
				<svg class="d3-visualization"></svg>
			</div>
		</div>
		

		<script>
			//audio_file.onchange = audioFileUploaded;
			var violent = new Violent();
		</script>


		<!-- testing soundcould -->
		<script src="//connect.soundcloud.com/sdk.js"></script>
		<script>
			var audio = new Audio();
			audio.src = "http://188.117.44.132:8000/;?r=4189"; 
			// "http://ai-radio.org:8000/radio.opus";
			audio.play();

			audio.addEventListener("canplaythrough", function () {
				console.log('The file is loaded and ready to play!');
				beatDebugGraph.init(
					    	300, 
					    	0, //Math.pow(155 * 1024, 2), 
					    	30000000, //Math.pow(255 * 1024, 2), 
					    	$('.d3-visualization').width(), 
					    	$('.d3-visualization').height());
				violent
			    	.audioStream(audio)
			    	.onImpulseBuffer(
			    		function(samples, index) {
			    			beatDebugGraph.update(samples, index);
			    			//index.log(samples); 
			    		})
			    	.output(true)
			    	.run();
				}, false);

			var clientId = 'd714d745be4390fe9d73c0bfd2a4909c';

			SC.initialize({
				client_id: clientId
			});

			var loadSoundcloud = function() {
				var searchTerm = soundcloud_input.value;
				console.log(searchTerm);

				//var testUrl = 'http://soundcloud.com/knifepartyinc/knife-party-begin-again';
			
				var resolveUrl = 'http://api.soundcloud.com/resolve.json?url=' + searchTerm + '&client_id=' +clientId;


				//"/users/frivolous/tracks"
				SC.get(resolveUrl, {limit: 1}, function(track){
					var url = track.stream_url + '?client_id=' + clientId;
					var name = track.title;
					file_name.innerHTML = name;
					console.log(track);

					var request = new XMLHttpRequest();
					  request.open('GET', url, true);
					  request.responseType = 'arraybuffer';

					  // Decode asynchronously
					  request.onload = function() {
					    var audio = request.response;
					    beatDebugGraph.init(
					    	300, 
					    	0, //Math.pow(155 * 1024, 2), 
					    	30000000, //Math.pow(255 * 1024, 2), 
					    	$('.d3-visualization').width(), 
					    	$('.d3-visualization').height());

					    violent
					    	.audioData(audio)
					    	.onImpulseBuffer(
					    		function(samples) {
					    			beatDebugGraph.update(samples);
					    			//console.log(samples); 
					    		})
					    	.output(true)
					    	.run();
					    //audioInit(request.response);
					  }
					  request.send();

					// var stream = SC.stream(url, 
					// 	function(sound){
					// 		console.log(sound);
					// 		sound.play();
					// 	});
				});	
			}
				
			var hash = document.location.hash;
			var paramsFromUrl = hash.split('##');
			var audioUrl = paramsFromUrl[0].split('#')[1];
			var videoUrl = paramsFromUrl[1];
			//console.log(audioUrl, videoUrl);

			var run = function() {
				//video.setAttribute('src', webm_input.value);
				share_url.innerHTML = document.location.origin + "#" + soundcloud_input.value + "##" + webm_input.value;
				loadSoundcloud(); 
			};

			//soundcloud_submit.onclick = run;

			if( audioUrl && videoUrl ) {
				soundcloud_input.value = audioUrl;
				webm_input.value = videoUrl;
				run();
			};

			
		</script>
	</body>
</html>